# Space Allocations Snapshot

This script calculates the current storage billing amounts by directly referencing the store and allocation tables, bypassing the reliance on receipts. While the current system uses receipts to track transient activity over a billing cycle, this approach can introduce errors that compound over time, leading to incorrect billing for users.

However, there is one issue with this solution: The allocation and store tables exclude deleted records, which means the amount charged for storage may not be fully accurate. Weâ€™re likely undercharging users as a result.

### Purpose

- Run this calculation on demand, ideally before each billing cycle, to make the billing amounts closer to reality.
- Use it to monitor system accuracy over time, continue periodic cross-checking until issues in the billing system are fully resolved.

### Usage

Create your own `.env.local` file and fill in the relevant details:

```sh
cp billing/scripts/space-allocations-snapshot/.env.template billing/scripts/space-allocations-snapshot/.env.local
```

You can run the allocation snapshot pipeline with the following optional arguments:

- `from=yyyy-mm-dd`: Start date for the snapshot. Defaults to the Unix epoch (1970-01-01) if not provided.
- `to=yyyy-mm-dd`: End date for the snapshot. Defaults to the first day of the next month if not provided.
- `customer=did:mailto:agent`: DID of the user account. Defaults to get all customers.

**Example Command:**

```sh
cd billing/scripts/space-allocations-snapshot
node index.js from=2024-11-01 to=2024-12-01
```

This script generates three output files:

- **`allocation-snapshot-{fromDate}_{toDate}.json`**: Contains detailed data about storage usage per customer and owned space.
- **`snapshot-{fromDate}_{toDate}.csv`**: Represents the snapshot data that should be stored in the snapshot table.
- **`summary-{fromDate}_{toDate}.csv`**: Summarizes the charges per customer. This can be compared with the file of the same name generated by the `dry-run` script.

### Upserting the Snapshot Table

The second script in this folder is designed to upsert the snapshot table with the contents of the `snapshot-{fromDate}_{toDate}.csv` file.  
To update the snapshot table with this data, simply run:

```sh
node upsert-snapshot-table.js snapshot-{fromDate}_{toDate}.csv
```
